name: Build release artifacts

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref_name }}-${{ github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  linux:
    name: Build Linux targets
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross
      - name: Build Linux targets
        run: |
          set -euo pipefail
          for target in x86_64-unknown-linux-musl aarch64-unknown-linux-musl armv7-unknown-linux-gnueabihf; do
            cross build --release --target "$target" --bins
            # Create target-specific directory
            dist_dir="dist/linux-${target}"
            mkdir -p "$dist_dir"
            # Copy owl binary
            cp "target/$target/release/owl" "$dist_dir/owl"
            sha256sum "$dist_dir/owl" > "$dist_dir/owl.sha256"
            # Copy owl-daemon binary as owld
            cp "target/$target/release/owl-daemon" "$dist_dir/owld"
            sha256sum "$dist_dir/owld" > "$dist_dir/owld.sha256"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: owl-binaries-linux
          path: dist/

  macos:
    name: Build macOS targets
    runs-on: ${{ matrix.os }}
    if: ${{ github.event_name != 'pull_request' }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install system dependencies
        run: |
          brew update
          brew install pkg-config openssl@3
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> "$GITHUB_ENV"
      - name: Build macOS artifacts
        run: |
          set -euo pipefail
          # Get the target architecture (e.g., aarch64-apple-darwin or x86_64-apple-darwin)
          target=$(rustc -vV | awk '/^host:/ {print $2}')
          # Extract just the architecture part (aarch64 or x86_64)
          arch=$(echo "$target" | cut -d'-' -f1)
          # Create target-specific directory with simplified name
          dist_dir="dist/macos-${arch}"
          mkdir -p "$dist_dir"
          cargo build --release --locked --bins
          # Copy owl binary
          cp "target/release/owl" "$dist_dir/owl"
          shasum -a 256 "$dist_dir/owl" > "$dist_dir/owl.sha256"
          # Copy owl-daemon binary as owld
          cp "target/release/owl-daemon" "$dist_dir/owld"
          shasum -a 256 "$dist_dir/owld" > "$dist_dir/owld.sha256"
      - uses: actions/upload-artifact@v4
        with:
          name: owl-binaries-macos-${{ matrix.os }}
          path: dist/

  cleanup:
    name: Cleanup old build artifacts
    if: ${{ always() && github.event_name == 'push' }}
    needs: [linux, macos]
    runs-on: ubuntu-latest
    steps:
      - name: Remove old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const keepCount = 3;
            const response = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const prefix = 'owl-binaries-';
            const artifacts = response.data.artifacts
              .filter(artifact => artifact.name.startsWith(prefix))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const toDelete = artifacts.slice(keepCount);
            for (const artifact of toDelete) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
